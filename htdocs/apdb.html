<html>
    <head>
        <script src="/jquery.js"></script>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">
            google.load("visualization", "1", {packages:["table"]});
            google.setOnLoadCallback(onLoad);

            function formatDuration(v) {
                var res = ""
                var s = v % 60;
                v = Math.floor(v / 60)
                var m = v % 60;
                v = Math.floor(v / 60)
                var h = v % 24;
                v = Math.floor(v / 24)
                if (v > 0) res += v + "d ";
                if (h > 0) res += h + "h ";
                if (m > 0) res += m + "m ";
//                if (s > 0) res += s + "s";
                return res;
            }

            var qtimer;
            var data;
            var table;

            function query() {
                var q = document.getElementById('q').value;
                $.getJSON( '?q='+q+'&fmt=json', {}, drawTable )
                    .always(function () {
                        qtimer = setTimeout(query, 3000);
                    })
                ;
            }

            function delayedQuery() {
                clearTimeout(qtimer);
                qtimer = setTimeout(query, 500);
            }

            function onLoad() {
                table = new google.visualization.Table(document.getElementById('table_div'));
                data = new google.visualization.DataTable();
                query();
            }

            function drawTable( jsdata ) {
                var scrollpos = document.documentElement.scrollTop || document.body.scrollTop;
                if (data.getNumberOfColumns() <= 0) {
                    for (c of jsdata["cols"].slice(1)) {
                        if (c["type"] == "duration") {
                            data.addColumn({"type":"number","label":c["label"]});
                        } else {
                            data.addColumn(c);
                        }
                    }
                }
                data.removeRows(0,data.getNumberOfRows());
                var n = 0;
                for (d of jsdata["data"]) {
                    data.addRow(d.slice(1));
                    for (var i=0; i<data.getNumberOfColumns(); i++) {
                        data.setProperty(n,i,"style",d[0]);
                        if (jsdata["cols"][i+1]["type"] == "duration") {
                            data.setFormattedValue(n, i, formatDuration(d[i+1]))
                        }
                    }
                    n++;
                }
                document.getElementById('no').innerHTML = n;
                var si = table.getSortInfo()
                table.draw(data, {
                    showRowNumber: false, 
                    allowHtml: true, 
                    sortColumn: si ? si.column : 0, 
                    sortAscending: si ? si.ascending : true, 
                    width: '100%',
                    'max-height': 'none',
                });
                $('#table_div').find('div').find('div').css('max-height', 'none');
                document.documentElement.scrollTop = scrollpos;
                document.body.scrollTop = scrollpos;
            }
        </script>
        <style>
            .google-visualization-table-tr-odd {
                background-color: #EAEAEA;
            }
        </style>
        <title>Freifunk Potsdam Access Point Database</title>
    </head>
    <body>
        <table><tr>
            <td style="padding-right:20px"><b>Suche:</b></td>
            <td><input id="q" type="text" size="30" oninput="delayedQuery()"></td>
            <td style="padding-left:20px"><b id="no">0</b><b> Eintr&auml;ge</b></td>
        </tr></table>
        <hr>
        <div id="table_div"></div>
    </body>
</html>
